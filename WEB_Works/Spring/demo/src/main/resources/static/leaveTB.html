<div class="row mb-2">
    <div class="col-12">
        <button type="button" class="btn btn-link btn-sm px-0 text-decoration-none" onclick="ADD_BTN()"><i class="icon-plus-sign-alt"></i>新增假單</button>
    </div>
</div>

<div class="row mb-2">
    <div class="col-12 col-sm-12 col-lg-3 col-xl-2 leaveSelect">
        <div class="d-flex">
            <label for="date" class="col-form-label mx-1">年份:</label>
            <select id="date" class="form-select text-center" value="" aria-label="Default select example"></select>
        </div>
    </div>

    <div class="col-12 col-sm-12 col-lg-3 col-xl-2 leaveSelect">
        <div class=" d-flex">
            <label for="review" class="col-form-label mx-1">審核:</label>
            <select id="review" class="form-select text-center" value="" aria-label="Default select example"></select>
        </div>
    </div>
    
</div>

<div class="row">
    <div class="col-12">
        <table id="showTB" class="display compact w-100"></table>
    </div>
</div>

<div class="modal fade" id="ModalADD">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="modal_addform" class="form" novalidate>
                <div class="modal-header">
                    <h3>新增假單</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body ">
                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-4 leaveaddform">
                            <label for="addform_JobAgent" class="col-form-label">職務代理人:</label>
                            <select id="addform_JobAgent" class="form-select mx-2" value=""
                                aria-label="Default select example" required>
                            </select>
                        </div>
                        <div class="col-3"></div>
                        <div class="col-5 leaveaddform">
                            <label for="addform_LeaveType" class="col-form-label">假別:</label>
                            <select id="addform_LeaveType" class="form-select mx-2" value=""
                                aria-label="Default select example" required>
                            </select>
                        </div>

                    </div>
                    <div class="row g-3 align-items-center mb-2">

                        <div class="col-12 leaveaddform">
                            <label for="addform_Sdate" class="col-form-label">起:</label>
                            <input type="datetime-local" id="addform_Sdate" value="" class="form-control mx-2" required>
                        </div>

                    </div>
                    <div class="row g-3 align-items-center mb-2">

                        <div class="col-12 leaveaddform">
                            <label for="addform_Edate" class="col-form-label">迄:</label>
                            <input type="datetime-local" id="addform_Edate" value="" class="form-control mx-2" required>
                        </div>

                    </div>

                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-12 text-center">
                            <label for="addform_reason" class="col-form-label">請假原因</label>
                            <textarea id="addform_reason" class="form-control" aria-label="With textarea" style="resize: none"></textarea>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center mb-2 d-none">
                        <div class="col-12 text-center">
                            <label for="addform_empid" class="col-form-label">EmpIndex</label>
                            <input type="text" id="addform_empid" value="" class="form-control mx-2" required>
                        </div>
                        <div class="col-12 leaveaddform">
                            <label for="addform_name" class="col-form-label">名字:</label>
                            <input type="text" id="addform_name" value="" class="form-control mx-2" readonly="readonly" required>
                        </div>
                    </div>
                </div>
            </form>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="Form_ADD()"><i class="icon-save"></i></button>
                <button type="button" class="btn btn-secondary" onclick="Modal_close('ADD')"><i class="icon-remove"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ModalUPD">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="modal_form" class="form">
                <div class="modal-header">
                    <h3 id="model_h3"></h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    
                    <div class="row g-3 align-items-center mb-2 updform">
                        <div class="col-3">
                            <label id="updform_id" class="col-form-label"></label>
                        </div>
                        <div class="col-5">
                            <label for="updform_JobAgent" class="col-form-label">職務代理:</label>
                            <select id="updform_JobAgent" class="form-select mx-2" value=""
                                aria-label="Default select example" required>
                            </select>
                        </div>
                        <!-- updform_JobAgent -->
                        <div class="col-4">
                            <label for="updform_LeaveType" class="col-form-label">假別:</label>
                            <select id="updform_LeaveType" class="form-select mx-2" value=""
                                aria-label="Default select example" required>
                            </select>
                        </div>

                    </div>
                    

                    <div class="row g-3 align-items-center mb-2 updform">
                        <div class="col-12 leaveaddform">
                            <label for="updform_Sdate" class="col-form-label">起:</label>
                            <input type="datetime-local" id="updform_Sdate" value="" class="form-control mx-2" required>
                        </div>
                        
                    </div>

                    <div class="row g-3 align-items-center mb-2 updform">
                        <div class="col-12 leaveaddform">
                            <label for="updform_Edate" class="col-form-label">迄:</label>
                            <input type="datetime-local" id="updform_Edate" value="" class="form-control mx-2" required>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-12 text-center">
                            <label for="updform_reason" class="col-form-label">請假原因</label>
                            <textarea id="updform_reason" class="form-control" aria-label="With textarea" style="resize: none"></textarea>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center d-none updform">
                        <div class="col-12">
                            <label for="updform_index" class="col-form-label">index:</label>
                            <input type="text" id="updform_index" class="form-control">
                        </div>

                        <div class="col-12">
                            <label for="updform_name" class="col-form-label">名字</label>
                            <input type="text" id="updform_name" value="" class="form-control mx-2" readonly="readonly" required>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center d-none updform">
                        <div class="col-12">
                            <label for="updform_empid" class="col-form-label">EmpIndex:</label>
                            <input type="text" id="updform_empid" class="form-control">
                        </div>
                    </div>
                </div>
            </form>
            <div id="model_footer" class="modal-footer"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="ModalShowlabel">
    <div class="modal-dialog ">
        <div class="modal-content">
            <form id="modal_form" class="form">
                <div class="modal-header">
                    <h3 id="label_h3"></h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    
                    <div class="row g-3 align-items-center mb-2 ">
                        <div class="col-4 ">
                            <label id="label_name" class="col-form-label">請假人:</label>
                        </div>
                        <div class="col-4 ">
                            <label id="label_JobAgent" class="col-form-label">職務代理:</label>
                        </div>
                        <div class="col-4 text-center">
                            <label id="label_LeaveType" class="col-form-label">假別:</label>
                        </div>
                    </div>

                    

                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-6">
                            <label id="label_Sdate" class="col-form-label">起:</label>
                        </div>
                        <div class="col-6">
                            <label id="label_Edate" class="col-form-label">迄:</label>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-12">
                            <label id="label_reason" class="col-form-label">請假原因:</label>
                        </div>
                    </div>

                    <div  class="row g-3 align-items-center mb-2">
                        <div class="col-12">
                            <label id="label_review_reason" class="col-form-label">主管備註:</label>
                        </div>
                    </div>

                    <div class="row g-3 align-items-center d-none">
                        <div class="col-12">
                            <label id="label_index" class="col-form-label">假單編號:</label>

                        </div>
                    </div>
                </div>
            </form>
            <div id="model_footer" class="modal-footer"></div>
        </div>
    </div>
</div>



<script>

    var LeaveType
    var JobAgent
    

    var showtable = (data) => {
        var table = $('#showTB').DataTable({
            "data": data,
            "columns": [ 
                {
                    data: null, title: "#",
                    render: function (data, type, row, meta) {
                        data.id = meta.row + 1
                        return data.id
                    }
                },
                { data: 'index', title: "假單ID"},
                { data: 'emp_name', title: "請假人" },
                { data: 'JobAgent', title: "職務代理人" },
                { data: 'JobAgent_id', title: "職務代理人ID" },
                { data: 'emp_id', title: "員工編號" },
                { data: 'type', title: "假別" },
                { data: 'start_date', title: "開始日期" },
                { data: 'end_date', title: "結束日期" },
                { data: 'review', title: "狀態" ,
                render: function (data, type, row, meta) {
                    let review
                    let color
                    if(row.review == "0"){
                        review = "過審"
                        color = 'green';
                    }else if(row.review == "1"){
                        review = "待審"
                    }else if(row.review == "2"){
                        review = "未過審"
                        color = 'red';
                    }
                        return '<span style="color:' + color + '">' + review + '</span>';
                    }},
                { data: 'reason', title: "請假原因" },
                { data: 'review_reason', title: "審核備註" },
                { data: 'type_id', title: "假別ID" },
                {
                    data: null, title: "功能",
                    render: function (data, type, row) {
                        return '<button type="button" class="btn btn-link"><i class="icon-edit"></i></button>'
                    }
                }
            ],
            "columnDefs": [
                {
                    "className": "dt-center",
                    "targets": [0,1,2,3,4,5,6,7,8,9,10,11,12,13]
                },
                {
                    "targets": [1,4,5,10,11,12],
                    "visible": false,
                    "searchable": false
                }
            ],
            "lengthMenu": [[-1], ["All"]],
        })
        //單擊
        $('#showTB').on("click", "button", function () {
            var data = table.row($(this).parents('tr')).data();
            let html=""

            switch (data.review) {
                case '0'://過審
                    
                    $('#label_h3')[0].innerHTML="假單已過審"
                    $('#label_h3')[0].classList.remove("text-danger");
                    $('#label_h3')[0].classList.add("text-success");
                    $('#label_name')[0].innerHTML= "請假人: " +data.emp_name
                    $('#label_JobAgent')[0].innerHTML= "職務代理人: " +data.JobAgent
                    $('#label_LeaveType')[0].innerHTML= "假別: " +data.type
                    $('#label_Sdate')[0].innerHTML= "起: " +data.start_date
                    $('#label_Edate')[0].innerHTML= "迄: " +data.end_date
                    $('#label_reason')[0].innerHTML= "請假原因: " +data.reason
                    $('#label_review_reason')[0].innerHTML= "主管備註: " +data.review_reason
                    $('#label_index')[0].innerHTML= "假單編號: " +data.index
                    
                    html += `<button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`
                    $('#model_footer')[0].innerHTML = html
                    $('#ModalShowlabel').modal('show')
                    break;
                case '1'://待審
                        $('#model_h3')[0].innerHTML="假單變更"
                        FormPush_LeaveType()
                        FormPush_JobAgent()
                        $('#updform_id')[0].innerHTML = "假單編號 : " + data.id
                        $('#updform_name').val(data.emp_name)
                        $('#updform_name').val(data.emp_name)
                        $('#updform_Sdate').val(data.start_date)
                        $('#updform_Edate').val(data.end_date)
                        $('#updform_reason').val(data.reason)
                        $('#updform_empid').val(data.emp_id)
                        $('#updform_index').val(data.index)
                        $('#updform_LeaveType').val(data.type_id)
                        $('#updform_JobAgent').val(data.JobAgent_id)

                        html=`
                        <button type="button" class="btn btn-primary" onclick="Form_UPD()"><i class="icon-save"></i></button>
                        <button type="button" class="btn btn-danger" onclick="Form_DEL()"><i class="icon-trash"></i></button>
                        <button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`

                        $('#model_footer')[0].innerHTML = html
                        $('#ModalUPD').modal('show')
                    break;
                case '2'://未過審
                        $('#label_h3')[0].innerHTML=`假單未過審`
                        $('#label_h3')[0].classList.remove("text-success");
                        $('#label_h3')[0].classList.add("text-danger");
                        $('#label_name')[0].innerHTML= "請假人: " +data.emp_name
                        $('#label_JobAgent')[0].innerHTML= "職務代理人: " +data.JobAgent
                        $('#label_LeaveType')[0].innerHTML= "假別: " +data.type
                        $('#label_Sdate')[0].innerHTML= "起: " +data.start_date
                        $('#label_Edate')[0].innerHTML= "迄: " +data.end_date
                        $('#label_reason')[0].innerHTML= "請假原因: " +data.reason
                        $('#label_review_reason')[0].innerHTML= "主管備註: " +data.review_reason
                        $('#label_index')[0].innerHTML= "假單編號: " +data.index

                        html += `<button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`
                        $('#model_footer')[0].innerHTML = html
                        $('#ModalShowlabel').modal('show')
                    break;
                default:
            }
        })
        //雙擊

        $('#showTB tbody').on('dblclick', 'tr', function () {
            var data = table.row(this).data();     
            let html=""

            switch (data.review) {
                case '0'://過審
                    
                    $('#label_h3')[0].innerHTML="假單已過審"
                    $('#label_h3')[0].classList.remove("text-danger");
                    $('#label_h3')[0].classList.add("text-success");
                    $('#label_name')[0].innerHTML= "請假人: " +data.emp_name
                    $('#label_JobAgent')[0].innerHTML= "職務代理人: " +data.JobAgent
                    $('#label_LeaveType')[0].innerHTML= "假別: " +data.type
                    $('#label_Sdate')[0].innerHTML= "起: " +data.start_date
                    $('#label_Edate')[0].innerHTML= "迄: " +data.end_date
                    $('#label_reason')[0].innerHTML= "請假原因: " +data.reason
                    $('#label_review_reason')[0].innerHTML= "主管備註: " +data.review_reason
                    $('#label_index')[0].innerHTML= "假單編號: " +data.index
                    
                    html += `<button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`
                    $('#model_footer')[0].innerHTML = html
                    $('#ModalShowlabel').modal('show')
                    break;
                case '1'://待審
                        $('#model_h3')[0].innerHTML="假單變更"
                        FormPush_LeaveType()
                        FormPush_JobAgent()
                        $('#updform_id')[0].innerHTML = "假單編號 : " + data.id
                        $('#updform_name').val(data.emp_name)
                        $('#updform_name').val(data.emp_name)
                        $('#updform_Sdate').val(data.start_date)
                        $('#updform_Edate').val(data.end_date)
                        $('#updform_reason').val(data.reason)
                        $('#updform_empid').val(data.emp_id)
                        $('#updform_index').val(data.index)
                        $('#updform_LeaveType').val(data.type_id)
                        $('#updform_JobAgent').val(data.JobAgent_id)

                        html=`
                        <button type="button" class="btn btn-primary" onclick="Form_UPD()"><i class="icon-save"></i></button>
                        <button type="button" class="btn btn-danger" onclick="Form_DEL()"><i class="icon-trash"></i></button>
                        <button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`

                        $('#model_footer')[0].innerHTML = html
                        $('#ModalUPD').modal('show')
                    break;
                case '2'://未過審
                        $('#label_h3')[0].innerHTML=`假單未過審`
                        $('#label_h3')[0].classList.remove("text-success");
                        $('#label_h3')[0].classList.add("text-danger");
                        $('#label_name')[0].innerHTML= "請假人: " +data.emp_name
                        $('#label_JobAgent')[0].innerHTML= "職務代理人: " +data.JobAgent
                        $('#label_LeaveType')[0].innerHTML= "假別: " +data.type
                        $('#label_Sdate')[0].innerHTML= "起: " +data.start_date
                        $('#label_Edate')[0].innerHTML= "迄: " +data.end_date
                        $('#label_reason')[0].innerHTML= "請假原因: " +data.reason
                        $('#label_review_reason')[0].innerHTML= "主管備註: " +data.review_reason
                        $('#label_index')[0].innerHTML= "假單編號: " +data.index

                        html += `<button type="button" class="btn btn-secondary" onclick="Modal_close('UPD')"><i class="icon-remove"></i></button>`
                        $('#model_footer')[0].innerHTML = html
                        $('#ModalShowlabel').modal('show')
                    break;
                default:
            }
        });

        $("#date").on("change",function(){
            getdata();
        })

        $("#review").on("change",function(){
            getdata();
        })


        var getdata = () =>{
            table.clear().draw();
            data={}
            data.year = $("#date")[0].value
            data.review = $("#review")[0].value
            $.ajax({
                url: "http://localhost:8080/Get_leaveTB",
                type: 'POST',
                data: JSON.stringify(data),
                success: function (rsp) {
                    let data = JSON.parse(rsp.data_str)
                    if(data.length>0){
                        table.rows.add(data).draw();
                    }
                },
                dataType: "json",
                contentType: "application/json"
            });
        }
    }
        
    var Validation = (str,arr) => {
        let j = arr.length
        let data = ""
        for(let i = 0 ;i < arr.length ; i++){
            if ($("#" + str + "form_" + arr[i] )[0].validity.valueMissing == false){
                data += '"' + arr[i] + '":"' + $('#' + str + 'form_' + arr[i]).val() +'",'
            }else{
                $("#" + str + "form_" + arr[i] )[0].setCustomValidity("請填寫");
                $("#" + str + "form_" + arr[i] )[0].reportValidity();
                j=j-1
            }
        }
        data += '"key":"' + j +'"'
        data="{" + data + "}"
        var json = JSON.parse(data)
        return json
    }

    var clearform = (data) => {
        if(data=='upd'){
            $("#"+ data +"form_review_reason").val("")
        }
        $("#"+ data +"form_LeaveType").val("")
        $("#"+ data +"form_Sdate").val("")
        $("#"+ data +"form_Edate").val("")
        $("#"+ data +"form_reason").val("")
    }
    var ADD_BTN = () => {
        clearform('add')
        $('#addform_name').val(getCookieByName('User'))
        $('#addform_empid').val(getCookieByName('ID'))
        FormPush_LeaveType()
        FormPush_JobAgent()
        $('#ModalADD').modal('show')
    }

    var Modal_close = (data) => {
        let id = '#Modal' + data
        $(id).modal('hide')
    }


    var Form_ADD = () => {

        let input = ["LeaveType","Sdate","Edate","name"]
        let data = Validation("add",input)
           
        if(data.key == input.length){
            delete data.key
            data.index = ""
            data.empid = $("#addform_empid").val()
            data.reason = $("#addform_reason").val()
            data.code = "add"
            data.Sdate = data.Sdate.replace("T"," ")
            data.Edate = data.Edate.replace("T"," ")
            _Post(data,"leaveTB",function(data) {
                if(data.code > 0){
                    $('#ModalADD').modal('hide')
                    $("#leave_show").load("./leaveTB.html") 
                }else{
                    $('#ModalADD').modal('hide')
                    $("#leave_show").load("./leaveTB.html")
                    alert("更新失敗")
                }
            })
            console.log("成功");
        }
    }

    var Form_UPD = () => {
        let input = ["LeaveType","Sdate","Edate"]
        let data = Validation("upd",input)

        if(data.key == input.length){
            delete data.key
            data.index = $("#updform_index").val()
            data.JobAgent = $("#updform_JobAgent").val()
            data.name = $("#updform_name").val()
            data.empid = $("#updform_empid").val()
            data.reason = $("#updform_reason").val()
            data.Sdate = data.Sdate.replace("T"," ")
            data.Edate = data.Edate.replace("T"," ")
            data.code = "upd"
            _Post(data,"leaveTB",function(data) {
                if(data.code > 0){
                    $('#ModalUPD').modal('hide')
                    $("#leave_show").load("./leaveTB.html") 
                }else{
                    $('#ModalUPD').modal('hide')
                    $("#leave_show").load("./leaveTB.html")
                    alert("更新失敗")
                }
            })
            console.log("成功");
        }
    }

    var Form_DEL = () => {
        let r = confirm("確認刪除資料?");
        if (r == true) {
            let data={}
            data.code="del"
			data.index = $("#updform_index").val()
            data.name = ""
            data.empid = ""
            data.Sdate = ""
            data.Edate = ""
            data.LeaveType = ""
            data.reason = ""
            
            _Post(data,"leaveTB",function(data) {
                if(data.code > 0){
                    $('#ModalUPD').modal('hide')
                    $("#leave_show").load("./leaveTB.html") 
                }else{
                    $('#ModalUPD').modal('hide')
                    $("#leave_show").load("./leaveTB.html")
                    alert("更新失敗")
                }
            })
            
        }
    }

    var Get_LeaveType = () => {
        $.ajax({
            url: "http://localhost:8080/Get_LeaveTypeTB",
            type: 'POST',
            success: function (rsp) {
                LeaveType = JSON.parse(rsp.data_str)
            },
            dataType: "json",
            contentType: "application/json"
        });
    }

    var Get_JobAgent = () => {
        let data = {}
        data.name = getCookieByName('User')
        _Post(data,"Get_JobAgent",function(rsp) {
            JobAgent = JSON.parse(rsp.data_str);
        })
    }

    var FormPush_LeaveType = () => {

        let html = `<option value="" selected>請選擇</option>`

        $.each(LeaveType, function (key, value) {
            html += `<option value="${value.index}">${value.type}</option>`
        });
        $("#addform_LeaveType")[0].innerHTML = html
        $("#updform_LeaveType")[0].innerHTML = html
    }

    var FormPush_JobAgent = () => {

        let html = `<option value="" selected>請選擇</option>`

        $.each(JobAgent, function (key, value) {
            html += `<option value="${value.index}">${value.userName}</option>`
        });
        $("#addform_JobAgent")[0].innerHTML = html
        $("#updform_JobAgent")[0].innerHTML = html
    }

    var Get_leaveTB = () => {
        data={}
        data.year = $("#date")[0].value
        data.review = $("#review")[0].value
        
        $.ajax({
            url: "http://localhost:8080/Get_leaveTB",
            type: 'POST',
            data: JSON.stringify(data),
            success: function (rsp) {
                showtable(JSON.parse(rsp.data_str))
                Get_LeaveType()
                Get_JobAgent()
            },
            dataType: "json",
            contentType: "application/json"
        });
    }
    var date = new Date();
    $("#date")[0].innerHTML = `
        <option value="${date.getFullYear()-1}">${date.getFullYear()-1}</option>
        <option selected value="${date.getFullYear()}">${date.getFullYear()}</option>
        <option value="${date.getFullYear()+1}">${date.getFullYear()+1}</option>`
    $("#review")[0].innerHTML = `<option selected value="all">ALL</option>
    <option value="0">過審</option>
    <option value="1">待審</option>
    <option value="2">未過審</option>
    `
    Get_leaveTB();

</script>